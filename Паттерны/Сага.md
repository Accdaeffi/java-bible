# О чём вообще
## Когда?
У нас есть интернет-магазин.
Клиенты валяются в одной БД, заказы в другой. 
Нам надо добавить заказ клиента, тем самым добавив строчку в БД "Заказы" и увеличив счётчик заказов у "Клиента".

## Проблема
А что, если при добавлениее возникнет внезапная ошибка? Например, кончится место в одной из БД.
Рабочее решение - локальные транзакции, которые откатывают в рамках одной БД. Но у нас-то их несколько.

## Решение
А давайте запилим свою реализацию транзакций - только теперь на несколько сервисов. 
И будет эта транзакция, как в эпических сагах, ходить по всем микросервисам и совершать деяния. А если не прокатит - сама сделает вид, будто её и не было.

Говоря проще, сага - набор локальных идемпонентных транзакций, исполняющихся асинхронно, с инструкциями, что делать в случае проблем.
Простейший вариант "что делать в случае проблем" - откатывать, но возможна дополнительная логика.

Гарантирует всё ACID, кроме изолированности.
Из BASE даёт всё, кроме базовой доступности.

# Общее
Есть 2 способа координации - Хореография и Оркестровка. Отличие в том, создавать ли специальный объект, который управляет сагой или нет.

#### Хореография
Распределённая. Каждый участник вызывает ивент для следующего участника саги.
В интернет магазине с использованием саги, основанной на хореографии, создание заказа будет включать следующие шаги:

1. Order Service (Сервис Заказа) создает Order (Заказ) в статусе pending (в ожидании) и публикует событие OrderCreated (Заказ создан)
2. Customer Service (Сервис Клиента) получает событие и пытается зарезервировать кредит для заказа. После чего публикует одно из двух событий: CreditReserved (Кредит зарезервирован) или CreditLimitExceeded (Кредитный лимит превышен)
3. Order Service (Сервис Заказа) получает событие и изменяет состояние заказа в approved (подтвержден) или cancelled (отменен)

##### Плюсы
1. Простая.
2. Хороша для простых саг.

##### Минусы
1. Циклические зависимости.
2. Труднее понять - логика распределена.
3. Компоненты сложнее.

#### Оркестровка
Централизированная. Специальный координатора отправляет и получает ивенты - и отвечает за общий успех.
В интернет магазине с использованием саги, основанной на оркестровке, создание заказа будет включать следующие шаги:

1. Order Service (Сервис Заказа) создает Order (Заказ) в статусе pending (в ожидании) и создает CreateOrderSaga (СагаСозданияЗаказа)
2. CreateOrderSaga (СагаСозданияЗаказа) отправляет команду ReserveCredit (ЗарезервироватьКредит) в Customer Service (Сервис Клиента)
3. Customer Service (Сервис Клиента) пытается зарезервировать кредит для заказа и отправляет назад ответ
4. CreateOrderSaga (СагаСозданияЗаказа) получает ответ и отправляет ApproveOrder (ПодтвердитьЗаказ) or RejectOrder (ОтменитьЗаказ) команду в Order Service (Сервис Заказа)
5. Order Service (Сервис Заказа) изменяет состояние заказа в approved (подтвержден) или cancelled (отменен)

##### Реализация координатора
1. Машина состояний
2. Saga Execution Coordinator
3. Event sourcing

##### Плюсы
1. Логика централизованная.
2. Лучшее разделение контента, проще понимание.
3. Хороша для больших саг.

##### Минусы
1. Риск переборщить с централизацией - и запихнуть всю бизнес-логику в координатора.

### Плюсы
1. Поддерживает согласованность между БД без использования распределённых транзакций.

### Минусы
1. Более трудно разрабатывать - например, необходимо продумывать компенсирующие транзакции, откатывающие изменения.

## Аналог - распределённые транзакции (2-фазовые коммиты (2PC))
Есть координатор, который проводит транзакцию, а потом спрашивает у всех, прошло ли.
Если у всех прошло - всем рассылается commit. Если у кого-то не прошло - всем рассылается rollback.

Проблемы:
1. Не скалируется.
2. Блокирующий протокол.
3. Прозиводительность определяется по самой медленной ноде.
4. Координатор - потенциальная точка падения.
5. Трудно смешивать различные технологии.